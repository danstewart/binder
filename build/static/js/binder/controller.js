function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _async_to_generator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)})}}function _check_private_redeclaration(obj,privateCollection){if(privateCollection.has(obj)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _class_private_method_get(receiver,privateSet,fn){if(!privateSet.has(receiver)){throw new TypeError("attempted to get private field on non-instance")}return fn}function _class_private_method_init(obj,privateSet){_check_private_redeclaration(obj,privateSet);privateSet.add(obj)}function _define_property(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _object_spread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};var ownKeys=Object.keys(source);if(typeof Object.getOwnPropertySymbols==="function"){ownKeys=ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function(sym){return Object.getOwnPropertyDescriptor(source,sym).enumerable}))}ownKeys.forEach(function(key){_define_property(target,key,source[key])})}return target}import{kebabToCamel,parseBoolean,parseDuration}from"./util.js";var _findRenderableElements=new WeakSet,_bindArgs=new WeakSet,_bindElements=new WeakSet,_bindEvents=new WeakSet,_findEventNodes=new WeakSet,_getElementType=new WeakSet;class Controller extends HTMLElement{static withTag(tag){var _this,_class;return _class=class extends(_this=this){},_define_property(_class,"tag",tag),_class}handleShadow(){this.template=this.querySelector("template");if(this.template){this.content=this.template.content.cloneNode(true);if(this.template.hasAttribute(":use-shadow")){this.debug({msg:"Initialising shadow DOM"});this.attachShadow({mode:"open"}).appendChild(this.content.cloneNode(true));this.root=this.shadowRoot;this.hasShadow=true}else{this.appendChild(this.content.cloneNode(true));this.hasShadow=false}}}connectedCallback(){var _this=this;return _async_to_generator(function*(){if(!_this.isConnected)return;_this.handleShadow();_this.bind();if("renderOnInit"in _this.args){_this.renderOnInit=parseBoolean(_this.args.renderOnInit)}else{_this.renderOnInit=true}yield _this.init(_this.args);if(_this.args.autoRender){const interval=parseDuration(_this.args.autoRender);_this.setAutoRender(interval)}if(_this.renderOnInit)_this.render();_this.emit("binder:connected",{})})()}disconnectedCallback(){this._events.forEach(e=>e.el.removeEventListener(e.eventType,e.event));this._events=[];this.emit("binder:disconnected",{detail:{from:this}})}attributeChangedCallback(name,oldValue,newValue){let handler=name.replace(/^data-/,"");handler=handler.replace(/^aria-/,"");handler=kebabToCamel(handler);handler=`set${handler.charAt(0).toUpperCase()}${handler.slice(1)}`;if(handler in this&&typeof this[handler]==="function"){this[handler](oldValue,newValue)}}emit(eventName,detail={},config={}){this.dispatchEvent(new CustomEvent(eventName,_object_spread({bubbles:true,cancelable:true,composed:true,detail:detail},config)))}listenFor(target,eventName,callback){target.addEventListener(eventName,e=>callback(e))}bind(){if(!this._internal.bound)_class_private_method_get(this,_bindArgs,bindArgs).call(this);_class_private_method_get(this,_bindElements,bindElements).call(this);_class_private_method_get(this,_bindEvents,bindEvents).call(this);this._internal.bound=true}setAutoRender(interval){if(interval===undefined){console.error(`[${this.localName}] Undefined interval passed to setAutoRender`);return}if(this._internal.autoRenderInterval){window.clearInterval(this._internal.autoRenderInterval)}this._internal.autoRenderInterval=window.setInterval(()=>this.render(),interval)}init(_args){return _async_to_generator(function*(){})()}render(rootNode=null){var _this=this;return _async_to_generator(function*(){if(!rootNode)rootNode=_this;_class_private_method_get(_this,_findRenderableElements,findRenderableElements).call(_this,rootNode).forEach(el=>{let template=el.getAttribute("_template");if(!template){template=el.innerText;el.setAttribute("_template",template)}const evalMode=el.hasAttribute(":render.eval");let replacerRegex=/\{(.*?)\}/g;template.replace(replacerRegex,(replacer,key)=>{if(evalMode){const fn=new Function(`return ${key}`);template=template.replace(replacer,fn.call(_this))}else{let pos=null;key.split(/[.[\]]/).filter(item=>!!item).forEach(part=>{part=part.replace(/["']/g,"");part=part.replace(/\(\)/g,"");if(pos==null&&part==="this"){pos=_this;return}if(pos&&part in pos){pos=pos[part]}else{pos=null;return}});if(pos==null)pos="";if(typeof pos==="function")pos=pos.call(_this);template=template.replace(replacer,pos.toString()||"")}});el.innerHTML=template});_this.emit("binder:render",{})})()}belongsToController(el){if(el.hasAttribute("data-controller"))el=el.parentElement;const closestController=el.closest("[data-controller]");return closestController===this}debug(obj){let shouldLog=false;if(window.__BINDER_DEBUG__===true)shouldLog=true;if(Array.isArray(window.__BINDER_DEBUG__)&&window.__BINDER_DEBUG__.includes(this.localName))shouldLog=true;if(shouldLog){obj.controller=this;console.debug(obj)}}constructor(args){super();_class_private_method_init(this,_findRenderableElements);_class_private_method_init(this,_bindArgs);_class_private_method_init(this,_bindElements);_class_private_method_init(this,_bindEvents);_class_private_method_init(this,_findEventNodes);_class_private_method_init(this,_getElementType);this.debug({msg:"Constructing binder element"});this._internal={};this.root=this;this.args=args||{};this.data={};this._events=[];if(this.innerHTML.trim()==="")this.innerHTML="<self></self>";this.self=this.querySelector("self");this.setAttribute("data-controller",this.localName);this.emit("binder:created",{})}}_define_property(Controller,"observedAttributes",[]);_define_property(Controller,"tag",undefined);function findRenderableElements(rootNode=null){if(!rootNode)rootNode=this;return[...rootNode.querySelectorAll("[\\:render]"),...rootNode.querySelectorAll("[\\:render\\.eval]")].filter(el=>this.belongsToController(el))}function bindArgs(){this.args={};this.getAttributeNames().forEach(attr=>{const value=this.getAttribute(attr);const key=kebabToCamel(attr).replace(":","");this.args[key]=value})}function bindElements(){this.binds={};const boundElements=this.querySelectorAll("[\\:bind]");boundElements.forEach(el=>{if(this.belongsToController(el)){const key=el.getAttribute(":bind");if(Object.hasOwn(this.binds,key)){if(Array.isArray(this.binds[key])){this.binds[key].push(el)}else{this.binds[key]=[this.binds[key],el]}}else{this.binds[key]=el}}})}function bindEvents(){this._events.forEach(e=>e.el.removeEventListener(e.eventType,e.event));this._events=[];var _this=this;const bindEvent=function(){var _ref=_async_to_generator(function*(el,eventType,modifiers){let attributeName=`@${eventType}`;if(modifiers.length)attributeName+=`.${modifiers.join(".")}`;const value=el.getAttribute(attributeName);const action=value.replace("this.","").replace("()","");const callable=function(){var _ref=_async_to_generator(function*(event){if(modifiers.includes("prevent"))event.preventDefault();if(modifiers.includes("stop"))event.stopPropagation();if(modifiers.includes("eval")){const fn=new Function("e",`${value}`);fn.call(_this,event)}else{try{if(action==="render"){yield _this[action].call(_this)}else{yield _this[action].call(_this,event)}}catch(e){console.error(`Failed to call '${action}' to handle '${event.type}' event on tag '${_this.localName}'`,e)}}if(modifiers.includes("render"))_this.render()});return function callable(event){return _ref.apply(this,arguments)}}();el.addEventListener(eventType,callable);_this._events.push({el:el,event:callable,eventType:eventType})});return function bindEvent(el,eventType,modifiers){return _ref.apply(this,arguments)}}();for(let node of _class_private_method_get(this,_findEventNodes,findEventNodes).call(this)){if(!this.belongsToController(node))continue;this.debug({msg:"Attaching event listeners",source:node});for(let attr of node.getAttributeNames()){if(!attr.startsWith("@"))continue;let[event,...modifiers]=attr.replace("@","").split(".");bindEvent(node,event,modifiers)}}}function*findEventNodes(){if(this.hasShadow){const allNodes=this.root.querySelectorAll("*");for(let node of allNodes){if(node.getAttributeNames().filter(attr=>attr.startsWith("@")).length>0){yield node}}}else{const nodesWithEvents=document.evaluate('.//*[@*[starts-with(name(), "@")]]',this.root);let eventNode=nodesWithEvents.iterateNext();while(eventNode){yield eventNode;eventNode=nodesWithEvents.iterateNext()}}}function getElementType(el){if(el.tagName.toLowerCase()==="input"){return[el.tagName,el.type].map(item=>item.toLowerCase()).join("|")}return el.tagName.toLowerCase()}export{Controller};
//# sourceMappingURL=controller.js.map